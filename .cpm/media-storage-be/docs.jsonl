{"id": "README.md:markdown:0", "text": "# media-storage-be", "metadata": {"source_id": "README.md", "ext": ".md", "lang": "markdown", "chunker": "markdown", "block_count": 1, "blocks_meta": [{"kind": "md_child", "title": "heading:0", "lang": "markdown", "level": "child", "parent_id": "README.md:md:section:0:heading:0", "child_index": 0}], "path": "README.md"}}
{"id": "src/main/java/it/aredegalli/media/MediaStorageApplication.java:treesitter:0", "text": "package it.aredegalli.media;\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.boot.context.properties.ConfigurationPropertiesScan;\nimport org.springframework.scheduling.annotation.EnableScheduling;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/MediaStorageApplication.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/MediaStorageApplication.java"}}
{"id": "src/main/java/it/aredegalli/media/MediaStorageApplication.java:treesitter:0", "text": "package it.aredegalli.media;\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.boot.context.properties.ConfigurationPropertiesScan;\nimport org.springframework.scheduling.annotation.EnableScheduling;\n@SpringBootApplication\n@ConfigurationPropertiesScan\n@EnableScheduling\npublic class MediaStorageApplication {\n\npackage it.aredegalli.media;\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.boot.context.properties.ConfigurationPropertiesScan;\nimport org.springframework.scheduling.annotation.EnableScheduling;\n\n@SpringBootApplication\n@ConfigurationPropertiesScan\n@EnableScheduling\npublic class MediaStorageApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(MediaStorageApplication.class, args);\n    }\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/MediaStorageApplication.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "MediaStorageApplication", "lang": "java", "line_start": 8, "line_end": 17, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/MediaStorageApplication.java:java:class_declaration:MediaStorageApplication:8-17", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/MediaStorageApplication.java"}}
{"id": "src/main/java/it/aredegalli/media/config/ActuatorConfig.java:treesitter:0", "text": "package it.aredegalli.media.config;\nimport org.springframework.boot.actuate.health.DefaultHealthContributorRegistry;\nimport org.springframework.boot.actuate.health.HealthContributorRegistry;\nimport org.springframework.boot.actuate.health.SimpleStatusAggregator;\nimport org.springframework.boot.actuate.health.StatusAggregator;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport java.util.Collections;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/config/ActuatorConfig.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/config/ActuatorConfig.java"}}
{"id": "src/main/java/it/aredegalli/media/config/ActuatorConfig.java:treesitter:0", "text": "package it.aredegalli.media.config;\nimport org.springframework.boot.actuate.health.DefaultHealthContributorRegistry;\nimport org.springframework.boot.actuate.health.HealthContributorRegistry;\nimport org.springframework.boot.actuate.health.SimpleStatusAggregator;\nimport org.springframework.boot.actuate.health.StatusAggregator;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport java.util.Collections;\n@Configuration\npublic class ActuatorConfig {\n\npackage it.aredegalli.media.config;\nimport org.springframework.boot.actuate.health.DefaultHealthContributorRegistry;\nimport org.springframework.boot.actuate.health.HealthContributorRegistry;\nimport org.springframework.boot.actuate.health.SimpleStatusAggregator;\nimport org.springframework.boot.actuate.health.StatusAggregator;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport java.util.Collections;\n\n@Configuration\npublic class ActuatorConfig {\n    @Bean\n    public StatusAggregator statusAggregator() {\n        return new SimpleStatusAggregator();\n    }\n    @Bean\n    public HealthContributorRegistry healthContributorRegistry() {\n        return new DefaultHealthContributorRegistry(Collections.emptyMap());\n    }\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/config/ActuatorConfig.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "ActuatorConfig", "lang": "java", "line_start": 12, "line_end": 24, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/config/ActuatorConfig.java:java:class_declaration:ActuatorConfig:12-24", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/config/ActuatorConfig.java"}}
{"id": "src/main/java/it/aredegalli/media/controller/StorageController.java:treesitter:0", "text": "package it.aredegalli.media.controller;\nimport it.aredegalli.media.dto.UploadResult;\nimport it.aredegalli.media.service.StorageService;\nimport jakarta.validation.constraints.NotNull;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.*;\nimport org.springframework.web.multipart.MultipartFile;\nimport org.springframework.web.servlet.mvc.method.annotation.StreamingResponseBody;\nimport java.io.IOException;\nimport java.io.InputStream;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/controller/StorageController.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/controller/StorageController.java"}}
{"id": "src/main/java/it/aredegalli/media/controller/StorageController.java:treesitter:0", "text": "package it.aredegalli.media.controller;\nimport it.aredegalli.media.dto.UploadResult;\nimport it.aredegalli.media.service.StorageService;\nimport jakarta.validation.constraints.NotNull;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.*;\nimport org.springframework.web.multipart.MultipartFile;\nimport org.springframework.web.servlet.mvc.method.annotation.StreamingResponseBody;\nimport java.io.IOException;\nimport java.io.InputStream;\n@Slf4j\n@RestController\n@RequiredArgsConstructor\n@RequestMapping(\"/api/storage\")\npublic class StorageController {\n\npackage it.aredegalli.media.controller;\nimport it.aredegalli.media.dto.UploadResult;\nimport it.aredegalli.media.service.StorageService;\nimport jakarta.validation.constraints.NotNull;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.*;\nimport org.springframework.web.multipart.MultipartFile;\nimport org.springframework.web.servlet.mvc.method.annotation.StreamingResponseBody;\nimport java.io.IOException;\nimport java.io.InputStream;\n\n@Slf4j\n@RestController\n@RequiredArgsConstructor\n@RequestMapping(\"/api/storage\")\npublic class StorageController {\n    private final StorageService storageService;\n    @PostMapping(value = \"/upload\", consumes = MediaType.ALL_VALUE)\n    public ResponseEntity<UploadResult> upload(@RequestParam(\"file\") MultipartFile file, @RequestParam(\"bucket\") String bucket) {\n        try {\n            log.info(\"Uploading file: {}\", file.getOriginalFilename());\n            return ResponseEntity.ok(this.storageService.upload(file.getInputStream(), file.getSize(), file.getContentType(), bucket));\n        } catch (Exception e) {\n            log.error(\"Upload failed: {}\", e.getMessage(), e);\n            throw new RuntimeException(\"Upload failed\", e);\n        }\n    }\n    @GetMapping(\"/download\")\n    public ResponseEntity<StreamingResponseBody> download(@RequestParam(\"bucket\") @NotNull String bucket, @RequestParam(\"key\") @NotNull String key) {\n        log.info(\"Download requested for file ID: {}\", key);\n        return _download(this.storageService.download(bucket, key), key);\n    }\n    @GetMapping(\"/download/token\")\n    public ResponseEntity<StreamingResponseBody> downloadGlb(@RequestParam(\"token\") @NotNull String token) {\n        log.info(\"Download requested for file token: {}\", token);\n        return _download(this.storageService.downloadSecure(token), token);\n    }\n    @GetMapping(\"/download/ensure\")\n    public ResponseEntity<String> ensureDownload(@RequestParam(\"bucket\") @NotNull String bucket, @RequestParam(\"key\") @NotNull String key) {\n        log.info(\"Ensuring download resource for file ID: {} and driver ID: {}\", key, bucket);\n        return ResponseEntity.ok(this.storageService.generatePresignedUrl(bucket, key));\n    }\n    @DeleteMapping\n    public void delete(@RequestParam(\"bucket\") @NotNull String bucket, @RequestParam(\"key\") @NotNull String key) {\n        log.info(\"Delete requested for file ID: {}\", key);\n        this.storageService.delete(bucket, key);\n    }\n    private ResponseEntity<StreamingResponseBody> _download(InputStream inputStream, String id) {\n        StreamingResponseBody responseBody = outputStream -> {\n            try (inputStream) {\n                byte[] buffer = new byte[4096];\n                int bytesRead;\n                while ((bytesRead = inputStream.read(buffer)) != -1) {\n                    outputStream.write(buffer, 0, bytesRead);\n                }\n                outputStream.flush();\n            } catch (IOException e) {\n                log.error(\"Error streaming file with ID: {}\", id);\n                throw new RuntimeException(\"Error streaming file\", e);\n            }\n        };\n        return ResponseEntity.ok()\n                .header(HttpHeaders.CONTENT_DISPOSITION, \"attachment; filename=\\\"\" + id + \"\\\"\")\n                .contentType(MediaType.APPLICATION_OCTET_STREAM)\n                .body(responseBody);\n    }\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/controller/StorageController.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "StorageController", "lang": "java", "line_start": 18, "line_end": 81, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/controller/StorageController.java:java:class_declaration:StorageController:18-81", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/controller/StorageController.java"}}
{"id": "src/main/java/it/aredegalli/media/dto/SecuredResourceResponseDto.java:treesitter:0", "text": "package it.aredegalli.media.dto;\nimport lombok.AllArgsConstructor;\nimport lombok.Builder;\nimport lombok.Data;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/dto/SecuredResourceResponseDto.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/dto/SecuredResourceResponseDto.java"}}
{"id": "src/main/java/it/aredegalli/media/dto/SecuredResourceResponseDto.java:treesitter:0", "text": "package it.aredegalli.media.dto;\nimport lombok.AllArgsConstructor;\nimport lombok.Builder;\nimport lombok.Data;\n@Data\n@Builder\n@AllArgsConstructor\npublic class SecuredResourceResponseDto {\n\npackage it.aredegalli.media.dto;\nimport lombok.AllArgsConstructor;\nimport lombok.Builder;\nimport lombok.Data;\n\n@Data\n@Builder\n@AllArgsConstructor\npublic class SecuredResourceResponseDto {\n    private String key;\n    private String bucket;\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/dto/SecuredResourceResponseDto.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "SecuredResourceResponseDto", "lang": "java", "line_start": 7, "line_end": 15, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/dto/SecuredResourceResponseDto.java:java:class_declaration:SecuredResourceResponseDto:7-15", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/dto/SecuredResourceResponseDto.java"}}
{"id": "src/main/java/it/aredegalli/media/dto/UploadResult.java:treesitter:0", "text": "package it.aredegalli.media.dto;\nimport lombok.AllArgsConstructor;\nimport lombok.Data;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/dto/UploadResult.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/dto/UploadResult.java"}}
{"id": "src/main/java/it/aredegalli/media/dto/UploadResult.java:treesitter:0", "text": "package it.aredegalli.media.dto;\nimport lombok.AllArgsConstructor;\nimport lombok.Data;\n@Data\n@AllArgsConstructor\npublic class UploadResult {\n\npackage it.aredegalli.media.dto;\nimport lombok.AllArgsConstructor;\nimport lombok.Data;\n\n@Data\n@AllArgsConstructor\npublic class UploadResult {\n    private final String objectKey;\n    private final byte[] hashBytes;\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/dto/UploadResult.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "UploadResult", "lang": "java", "line_start": 6, "line_end": 11, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/dto/UploadResult.java:java:class_declaration:UploadResult:6-11", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/dto/UploadResult.java"}}
{"id": "src/main/java/it/aredegalli/media/security/SecurityConfig.java:treesitter:0", "text": "package it.aredegalli.media.security;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\nimport org.springframework.security.config.annotation.web.configurers.HeadersConfigurer;\nimport org.springframework.security.config.http.SessionCreationPolicy;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.web.cors.CorsConfiguration;\nimport org.springframework.web.cors.CorsConfigurationSource;\nimport org.springframework.web.cors.UrlBasedCorsConfigurationSource;\nimport java.util.Arrays;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/security/SecurityConfig.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/security/SecurityConfig.java"}}
{"id": "src/main/java/it/aredegalli/media/security/SecurityConfig.java:treesitter:0", "text": "package it.aredegalli.media.security;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\nimport org.springframework.security.config.annotation.web.configurers.HeadersConfigurer;\nimport org.springframework.security.config.http.SessionCreationPolicy;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.web.cors.CorsConfiguration;\nimport org.springframework.web.cors.CorsConfigurationSource;\nimport org.springframework.web.cors.UrlBasedCorsConfigurationSource;\nimport java.util.Arrays;\n@Configuration\n@EnableWebSecurity\n@RequiredArgsConstructor\npublic class SecurityConfig {\n\npackage it.aredegalli.media.security;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\nimport org.springframework.security.config.annotation.web.configurers.HeadersConfigurer;\nimport org.springframework.security.config.http.SessionCreationPolicy;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.web.cors.CorsConfiguration;\nimport org.springframework.web.cors.CorsConfigurationSource;\nimport org.springframework.web.cors.UrlBasedCorsConfigurationSource;\nimport java.util.Arrays;\n\n@Configuration\n@EnableWebSecurity\n@RequiredArgsConstructor\npublic class SecurityConfig {\n    @Value(\"${security.cors.allowed-origins:*}\")\n    private String allowedOrigins;\n    @Value(\"${security.cors.allowed-methods:*}\")\n    private String allowedMethods;\n    @Value(\"${security.cors.allowed-headers:*}\")\n    private String allowedHeaders;\n    @Bean\n    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {\n        http\n                .csrf(AbstractHttpConfigurer::disable)\n                .cors(cors -> cors.configurationSource(corsConfigurationSource()))\n                .authorizeHttpRequests(auth -> auth\n                        .requestMatchers(\"/swagger-ui/**\", \"/v3/api-docs/**\").permitAll()\n                        .requestMatchers(\"/api/**\").permitAll()\n                        .requestMatchers(\"/actuator/**\").permitAll()\n                        .anyRequest().denyAll()\n                )\n                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))\n                .headers(headers -> headers\n                        .httpStrictTransportSecurity(hsts -> hsts.includeSubDomains(true).maxAgeInSeconds(31536000))\n                        .contentSecurityPolicy(csp -> csp.policyDirectives(\"default-src 'self'\"))\n                        .frameOptions(HeadersConfigurer.FrameOptionsConfig::sameOrigin)\n                );\n        return http.build();\n    }\n    @Bean\n    public CorsConfigurationSource corsConfigurationSource() {\n        CorsConfiguration config = new CorsConfiguration();\n        config.setAllowedOriginPatterns(Arrays.asList(allowedOrigins.split(\",\")));\n        config.setAllowedMethods(Arrays.asList(allowedMethods.split(\",\")));\n        config.setAllowedHeaders(Arrays.asList(allowedHeaders.split(\",\")));\n        config.setAllowCredentials(true);\n        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();\n        source.registerCorsConfiguration(\"/**\", config);\n        return source;\n    }\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/security/SecurityConfig.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "SecurityConfig", "lang": "java", "line_start": 19, "line_end": 66, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/security/SecurityConfig.java:java:class_declaration:SecurityConfig:19-66", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/security/SecurityConfig.java"}}
{"id": "src/main/java/it/aredegalli/media/service/StorageService.java:treesitter:0", "text": "package it.aredegalli.media.service;\nimport it.aredegalli.media.dto.UploadResult;\nimport java.io.IOException;\nimport java.io.InputStream;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/service/StorageService.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/service/StorageService.java"}}
{"id": "src/main/java/it/aredegalli/media/service/StorageService.java:treesitter:0", "text": "package it.aredegalli.media.service;\nimport it.aredegalli.media.dto.UploadResult;\nimport java.io.IOException;\nimport java.io.InputStream;\npublic interface StorageService {\n\npackage it.aredegalli.media.service;\nimport it.aredegalli.media.dto.UploadResult;\nimport java.io.IOException;\nimport java.io.InputStream;\n\npublic interface StorageService {\n    /**\n     * Carica lo stream sul bucket, calcola l’hash, e restituisce la chiave e l’hash.\n     */\n    UploadResult upload(InputStream data,\n                        long size,\n                        String contentType,\n                        String bucket) throws IOException;\n    /**\n     * Ritorna uno InputStream dei dati salvati con quella chiave.\n     */\n    InputStream download(String bucket, String objectKey);\n    void delete(String bucket, String objectKey);\n    String generatePresignedUrl(String bucket, String objectKey);\n    InputStream downloadSecure(String token);\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/service/StorageService.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "interface_declaration", "symbol": "StorageService", "lang": "java", "line_start": 8, "line_end": 27, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/StorageService.java:java:interface_declaration:StorageService:8-27", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/service/StorageService.java"}}
{"id": "src/main/java/it/aredegalli/media/service/StorageServiceImpl.java:treesitter:0", "text": "package it.aredegalli.media.service;\nimport it.aredegalli.media.config.s3.S3BucketInitializer;\nimport it.aredegalli.media.dto.UploadResult;\nimport it.aredegalli.media.service.component.ResourceSecureDownloadService;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.stereotype.Service;\nimport software.amazon.awssdk.core.sync.RequestBody;\nimport software.amazon.awssdk.services.s3.S3Client;\nimport software.amazon.awssdk.services.s3.model.CopyObjectRequest;\nimport software.amazon.awssdk.services.s3.model.DeleteObjectRequest;\nimport software.amazon.awssdk.services.s3.model.GetObjectRequest;\nimport software.amazon.awssdk.services.s3.model.PutObjectRequest;\nimport java.io.InputStream;\nimport java.io.PipedInputStream;\nimport java.io.PipedOutputStream;\nimport java.security.DigestInputStream;\nimport java.security.MessageDigest;\nimport java.util.UUID;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/service/StorageServiceImpl.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/service/StorageServiceImpl.java"}}
{"id": "src/main/java/it/aredegalli/media/service/StorageServiceImpl.java:treesitter:0", "text": "package it.aredegalli.media.service;\nimport it.aredegalli.media.config.s3.S3BucketInitializer;\nimport it.aredegalli.media.dto.UploadResult;\nimport it.aredegalli.media.service.component.ResourceSecureDownloadService;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.stereotype.Service;\nimport software.amazon.awssdk.core.sync.RequestBody;\nimport software.amazon.awssdk.services.s3.S3Client;\nimport software.amazon.awssdk.services.s3.model.CopyObjectRequest;\nimport software.amazon.awssdk.services.s3.model.DeleteObjectRequest;\nimport software.amazon.awssdk.services.s3.model.GetObjectRequest;\nimport software.amazon.awssdk.services.s3.model.PutObjectRequest;\nimport java.io.InputStream;\nimport java.io.PipedInputStream;\nimport java.io.PipedOutputStream;\nimport java.security.DigestInputStream;\nimport java.security.MessageDigest;\nimport java.util.UUID;\n@Service\n@RequiredArgsConstructor\npublic class StorageServiceImpl implements StorageService {\n\npackage it.aredegalli.media.service;\nimport it.aredegalli.media.config.s3.S3BucketInitializer;\nimport it.aredegalli.media.dto.UploadResult;\nimport it.aredegalli.media.service.component.ResourceSecureDownloadService;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.stereotype.Service;\nimport software.amazon.awssdk.core.sync.RequestBody;\nimport software.amazon.awssdk.services.s3.S3Client;\nimport software.amazon.awssdk.services.s3.model.CopyObjectRequest;\nimport software.amazon.awssdk.services.s3.model.DeleteObjectRequest;\nimport software.amazon.awssdk.services.s3.model.GetObjectRequest;\nimport software.amazon.awssdk.services.s3.model.PutObjectRequest;\nimport java.io.InputStream;\nimport java.io.PipedInputStream;\nimport java.io.PipedOutputStream;\nimport java.security.DigestInputStream;\nimport java.security.MessageDigest;\nimport java.util.UUID;\n\n@Service\n@RequiredArgsConstructor\npublic class StorageServiceImpl implements StorageService {\n    private final S3Client s3Client;\n    private final ResourceSecureDownloadService resourceSecureDownloadService;\n    private final S3BucketInitializer s3BucketInitializer;\n    @Override\n    public UploadResult upload(InputStream data,\n                               long size,\n                               String contentType,\n                               String bucket) {\n        byte[] hashBytes;\n        String hashHex;\n        String tempKey = UUID.randomUUID().toString();\n        try {\n            MessageDigest md = MessageDigest.getInstance(\"SHA-256\");\n            DigestInputStream dis = new DigestInputStream(data, md);\n            PipedOutputStream pos = new PipedOutputStream();\n            PipedInputStream pis = new PipedInputStream(pos, 8 * 1024);\n            Thread pump = getDigestThread(dis, pos);\n            this.s3BucketInitializer.createBucketIfNotExists(bucket);\n            PutObjectRequest tempPut = PutObjectRequest.builder()\n                    .bucket(bucket)\n                    .key(tempKey)\n                    .contentType(contentType)\n                    .contentLength(size)\n                    .build();\n            s3Client.putObject(tempPut, RequestBody.fromInputStream(pis, size));\n            pump.join();\n            hashBytes = md.digest();\n            StringBuilder sb = new StringBuilder(2 * hashBytes.length);\n            for (byte b : hashBytes) sb.append(String.format(\"%02x\", b));\n            hashHex = sb.toString();\n            CopyObjectRequest copyReq = CopyObjectRequest.builder()\n                    .copySource(bucket + \"/\" + tempKey)\n                    .destinationBucket(bucket)\n                    .destinationKey(hashHex)\n                    .build();\n            s3Client.copyObject(copyReq);\n            DeleteObjectRequest delReq = DeleteObjectRequest.builder()\n                    .bucket(bucket)\n                    .key(tempKey)\n                    .build();\n            s3Client.deleteObject(delReq);\n        } catch (Exception e) {\n            throw new RuntimeException(\"Errore durante l'upload dello stream\", e);\n        }\n        return new UploadResult(hashHex, hashBytes);\n    }\n    @Override\n    public InputStream download(String bucket, String objectKey) {\n        GetObjectRequest getReq = GetObjectRequest.builder()\n                .bucket(bucket)\n                .key(objectKey)\n                .build();\n        return s3Client.getObject(getReq);\n    }\n    @Override\n    public void delete(String bucket, String objectKey) {\n        DeleteObjectRequest delReq = DeleteObjectRequest.builder()\n                .bucket(bucket)\n                .key(objectKey)\n                .build();\n        s3Client.deleteObject(delReq);\n    }\n    @Override\n    public String generatePresignedUrl(String bucket, String objectKey) {\n        return this.resourceSecureDownloadService.generateSecureDownloadToken(objectKey, bucket);\n    }\n    @Override\n    public InputStream downloadSecure(String token) {\n        var info = this.resourceSecureDownloadService.validateTokenAndExtractResourceId(token);\n        return this.download(info.getBucket(), info.getKey());\n    }\n    private static Thread getDigestThread(DigestInputStream dis, PipedOutputStream pos) {\n        Thread pump = new Thread(() -> {\npublic String generatePresignedUrl(String bucket, String objectKey) {\n        return this.resourceSecureDownloadService.generateSecureDownloadToken(objectKey, bucket);\n    }\n    @Override\n    public InputStream downloadSecure(String token) {\n        var info = this.resourceSecureDownloadService.validateTokenAndExtractResourceId(token);\n        return this.download(info.getBucket(), info.getKey());\n    }\n    private static Thread getDigestThread(DigestInputStream dis, PipedOutputStream pos) {\n        Thread pump = new Thread(() -> {\n            byte[] buffer = new byte[4 * 1024];\n            int read;\n            try {\n                while ((read = dis.read(buffer)) != -1) {\n                    pos.write(buffer, 0, read);\n                }\n            } catch (Exception ignored) {\n            } finally {\n                try {\n                    pos.close();\n                } catch (Exception ignored) {\n                }\n                try {\n                    dis.close();\n                } catch (Exception ignored) {\n                }\n            }\n        }, \"s3-hash-pump\");\n        pump.start();\n        return pump;\n    }\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/service/StorageServiceImpl.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 2, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "StorageServiceImpl", "lang": "java", "line_start": 26, "line_end": 139, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/StorageServiceImpl.java:java:class_declaration:StorageServiceImpl:26-139", "child_index": 0}, {"kind": "symbol_child", "node_type": "class_declaration", "symbol": "StorageServiceImpl", "lang": "java", "line_start": 26, "line_end": 139, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/StorageServiceImpl.java:java:class_declaration:StorageServiceImpl:26-139", "child_index": 1}], "path": "src/main/java/it/aredegalli/media/service/StorageServiceImpl.java"}}
{"id": "src/main/java/it/aredegalli/media/util/HashUtil.java:treesitter:0", "text": "package it.aredegalli.media.util;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.stereotype.Component;\nimport javax.crypto.Mac;\nimport javax.crypto.spec.SecretKeySpec;\nimport java.nio.charset.StandardCharsets;\nimport java.security.MessageDigest;\nimport java.security.NoSuchAlgorithmException;\nimport java.util.Base64;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/util/HashUtil.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/util/HashUtil.java"}}
{"id": "src/main/java/it/aredegalli/media/util/HashUtil.java:treesitter:0", "text": "package it.aredegalli.media.util;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.stereotype.Component;\nimport javax.crypto.Mac;\nimport javax.crypto.spec.SecretKeySpec;\nimport java.nio.charset.StandardCharsets;\nimport java.security.MessageDigest;\nimport java.security.NoSuchAlgorithmException;\nimport java.util.Base64;\n@Component\npublic class HashUtil {\n\npackage it.aredegalli.media.util;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.stereotype.Component;\nimport javax.crypto.Mac;\nimport javax.crypto.spec.SecretKeySpec;\nimport java.nio.charset.StandardCharsets;\nimport java.security.MessageDigest;\nimport java.security.NoSuchAlgorithmException;\nimport java.util.Base64;\n\n@Component\npublic class HashUtil {\n    @Value(\"${hmac.secret.key}\")\n    private String secretKey;\n    public String hmacSha256(String data) {\n        try {\n            byte[] keyBytes = Base64.getDecoder().decode(secretKey);\n            Mac mac = Mac.getInstance(\"HmacSHA256\");\n            SecretKeySpec secretKeySpec = new SecretKeySpec(keyBytes, \"HmacSHA256\");\n            mac.init(secretKeySpec);\n            byte[] hashBytes = mac.doFinal(data.getBytes(StandardCharsets.UTF_8));\n            return Base64.getEncoder().encodeToString(hashBytes);\n        } catch (Exception e) {\n            throw new RuntimeException(\"HMAC-SHA256 error\", e);\n        }\n    }\n    public String sha256(String input) {\n        try {\n            MessageDigest digest = MessageDigest.getInstance(\"SHA-256\");\n            byte[] hashBytes = digest.digest(input.getBytes(StandardCharsets.UTF_8));\n            StringBuilder hexString = new StringBuilder();\n            for (byte b : hashBytes) {\n                String hex = Integer.toHexString(0xff & b);\n                if (hex.length() == 1) hexString.append('0');\n                hexString.append(hex);\n            }\n            return hexString.toString();\n        } catch (NoSuchAlgorithmException e) {\n            throw new RuntimeException(\"SHA-256 not supported\", e);\n        }\n    }\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/util/HashUtil.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "HashUtil", "lang": "java", "line_start": 13, "line_end": 49, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/util/HashUtil.java:java:class_declaration:HashUtil:13-49", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/util/HashUtil.java"}}
{"id": "src/main/java/it/aredegalli/media/config/redis/RedisConfig.java:treesitter:0", "text": "package it.aredegalli.media.config.redis;\nimport com.fasterxml.jackson.annotation.JsonTypeInfo;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.jsontype.BasicPolymorphicTypeValidator;\nimport com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;\nimport org.springframework.cache.annotation.EnableCaching;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.data.redis.cache.RedisCacheConfiguration;\nimport org.springframework.data.redis.cache.RedisCacheManager;\nimport org.springframework.data.redis.connection.RedisConnectionFactory;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;\nimport org.springframework.data.redis.serializer.RedisSerializationContext;\nimport org.springframework.data.redis.serializer.StringRedisSerializer;\nimport java.time.Duration;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/config/redis/RedisConfig.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/config/redis/RedisConfig.java"}}
{"id": "src/main/java/it/aredegalli/media/config/redis/RedisConfig.java:treesitter:0", "text": "package it.aredegalli.media.config.redis;\nimport com.fasterxml.jackson.annotation.JsonTypeInfo;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.jsontype.BasicPolymorphicTypeValidator;\nimport com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;\nimport org.springframework.cache.annotation.EnableCaching;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.data.redis.cache.RedisCacheConfiguration;\nimport org.springframework.data.redis.cache.RedisCacheManager;\nimport org.springframework.data.redis.connection.RedisConnectionFactory;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;\nimport org.springframework.data.redis.serializer.RedisSerializationContext;\nimport org.springframework.data.redis.serializer.StringRedisSerializer;\nimport java.time.Duration;\n@Configuration\n@EnableCaching\npublic class RedisConfig {\n\npackage it.aredegalli.media.config.redis;\nimport com.fasterxml.jackson.annotation.JsonTypeInfo;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.jsontype.BasicPolymorphicTypeValidator;\nimport com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;\nimport org.springframework.cache.annotation.EnableCaching;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.data.redis.cache.RedisCacheConfiguration;\nimport org.springframework.data.redis.cache.RedisCacheManager;\nimport org.springframework.data.redis.connection.RedisConnectionFactory;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;\nimport org.springframework.data.redis.serializer.RedisSerializationContext;\nimport org.springframework.data.redis.serializer.StringRedisSerializer;\nimport java.time.Duration;\n\n@Configuration\n@EnableCaching\npublic class RedisConfig {\n    /**\n     * Configura il RedisTemplate per operazioni dirette su Redis.\n     *\n     * Il RedisTemplate è l'interfaccia principale per interagire con Redis.\n     * Qui lo configuriamo per usare:\n     * - StringRedisSerializer per le chiavi (più leggibile nei tool di debug)\n     * - GenericJackson2JsonRedisSerializer per i valori (supporta qualsiasi oggetto Java)\n     */\n    @Bean\n    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {\n        RedisTemplate<String, Object> template = new RedisTemplate<>();\n        template.setConnectionFactory(connectionFactory);\n        // Configuriamo ObjectMapper per gestire correttamente i tipi Java\n        ObjectMapper objectMapper = new ObjectMapper();\n        objectMapper.registerModule(new JavaTimeModule()); // Supporto per LocalDate, LocalDateTime, etc.\n        // Abilita il type info per permettere la deserializzazione corretta\n        // Questo aggiunge informazioni sul tipo nell'JSON per ricostruire l'oggetto giusto\n        objectMapper.activateDefaultTyping(\n            BasicPolymorphicTypeValidator.builder()\n                .allowIfBaseType(Object.class)\n                .build(),\n            ObjectMapper.DefaultTyping.NON_FINAL,\n            JsonTypeInfo.As.PROPERTY\n        );\n        GenericJackson2JsonRedisSerializer jackson2JsonRedisSerializer =\n            new GenericJackson2JsonRedisSerializer(objectMapper);\n        // Configuriamo i serializer per chiavi e valori\n        StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();\n        template.setKeySerializer(stringRedisSerializer);\n        template.setValueSerializer(jackson2JsonRedisSerializer);\n        template.setHashKeySerializer(stringRedisSerializer);\n        template.setHashValueSerializer(jackson2JsonRedisSerializer);\n        template.afterPropertiesSet();\n        return template;\n    }\n    /**\n     * Configura il CacheManager per l'annotazione @Cacheable di Spring.\n     *\n     * Questo bean gestisce automaticamente il caching dichiarativo.\n     * Puoi configurare diversi TTL (Time To Live) per diverse cache.\n     */\n    @Bean\n    public RedisCacheManager cacheManager(RedisConnectionFactory connectionFactory) {\n        // Configurazione di default per tutte le cache\n        RedisCacheConfiguration defaultConfig = RedisCacheConfiguration.defaultCacheConfig()\n            .entryTtl(Duration.ofMinutes(10)) // TTL di default: 10 minuti\n            .disableCachingNullValues() // Non cachare valori null\n            .serializeKeysWith(\n                RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer())\n            )\n            .serializeValuesWith(\n                RedisSerializationContext.SerializationPair.fromSerializer(\n                    new GenericJackson2JsonRedisSerializer()\n                )\n            );\npublic RedisCacheManager cacheManager(RedisConnectionFactory connectionFactory) {\n        // Configurazione di default per tutte le cache\n        RedisCacheConfiguration defaultConfig = RedisCacheConfiguration.defaultCacheConfig()\n            .entryTtl(Duration.ofMinutes(10)) // TTL di default: 10 minuti\n            .disableCachingNullValues() // Non cachare valori null\n            .serializeKeysWith(\n                RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer())\n            )\n            .serializeValuesWith(\n                RedisSerializationContext.SerializationPair.fromSerializer(\n                    new GenericJackson2JsonRedisSerializer()\n                )\n            );\n        // Puoi anche configurare cache specifiche con TTL diversi\n        // Map<String, RedisCacheConfiguration> cacheConfigurations = new HashMap<>();\n        // cacheConfigurations.put(\"users\", defaultConfig.entryTtl(Duration.ofHours(1)));\n        // cacheConfigurations.put(\"products\", defaultConfig.entryTtl(Duration.ofMinutes(30)));\n        return RedisCacheManager.builder(connectionFactory)\n            .cacheDefaults(defaultConfig)\n            // .withInitialCacheConfigurations(cacheConfigurations) // Configurazioni per cache specifiche\n            .build();\n    }\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/config/redis/RedisConfig.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 2, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "RedisConfig", "lang": "java", "line_start": 27, "line_end": 104, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/config/redis/RedisConfig.java:java:class_declaration:RedisConfig:27-104", "child_index": 0}, {"kind": "symbol_child", "node_type": "class_declaration", "symbol": "RedisConfig", "lang": "java", "line_start": 27, "line_end": 104, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/config/redis/RedisConfig.java:java:class_declaration:RedisConfig:27-104", "child_index": 1}], "path": "src/main/java/it/aredegalli/media/config/redis/RedisConfig.java"}}
{"id": "src/main/java/it/aredegalli/media/config/s3/S3BucketInitializer.java:treesitter:0", "text": "package it.aredegalli.media.config.s3;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.boot.context.event.ApplicationReadyEvent;\nimport org.springframework.context.event.EventListener;\nimport org.springframework.stereotype.Component;\nimport software.amazon.awssdk.services.s3.S3Client;\nimport software.amazon.awssdk.services.s3.model.CreateBucketRequest;\nimport software.amazon.awssdk.services.s3.model.HeadBucketRequest;\nimport software.amazon.awssdk.services.s3.model.NoSuchBucketException;\nimport java.util.List;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/config/s3/S3BucketInitializer.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/config/s3/S3BucketInitializer.java"}}
{"id": "src/main/java/it/aredegalli/media/config/s3/S3BucketInitializer.java:treesitter:0", "text": "package it.aredegalli.media.config.s3;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.boot.context.event.ApplicationReadyEvent;\nimport org.springframework.context.event.EventListener;\nimport org.springframework.stereotype.Component;\nimport software.amazon.awssdk.services.s3.S3Client;\nimport software.amazon.awssdk.services.s3.model.CreateBucketRequest;\nimport software.amazon.awssdk.services.s3.model.HeadBucketRequest;\nimport software.amazon.awssdk.services.s3.model.NoSuchBucketException;\nimport java.util.List;\n@Component\n@RequiredArgsConstructor\n@Slf4j\npublic class S3BucketInitializer {\n\npackage it.aredegalli.media.config.s3;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.boot.context.event.ApplicationReadyEvent;\nimport org.springframework.context.event.EventListener;\nimport org.springframework.stereotype.Component;\nimport software.amazon.awssdk.services.s3.S3Client;\nimport software.amazon.awssdk.services.s3.model.CreateBucketRequest;\nimport software.amazon.awssdk.services.s3.model.HeadBucketRequest;\nimport software.amazon.awssdk.services.s3.model.NoSuchBucketException;\nimport java.util.List;\n\n@Component\n@RequiredArgsConstructor\n@Slf4j\npublic class S3BucketInitializer {\n    private final S3Client s3Client;\n    public void createBucketIfNotExists(String bucketName) {\n        try {\n            if (bucketExists(bucketName)) {\n                log.info(\"✓ Bucket '{}' già esistente\", bucketName);\n                return;\n            }\n            CreateBucketRequest request = CreateBucketRequest.builder()\n                .bucket(bucketName)\n                .build();\n            s3Client.createBucket(request);\n            log.info(\"✓ Bucket '{}' creato con successo\", bucketName);\n        } catch (Exception e) {\n            log.error(\"✗ Errore creazione bucket '{}': {}\", bucketName, e.getMessage());\n        }\n    }\n    public boolean bucketExists(String bucketName) {\n        try {\n            s3Client.headBucket(HeadBucketRequest.builder().bucket(bucketName).build());\n            return true;\n        } catch (NoSuchBucketException e) {\n            return false;\n        }\n    }\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/config/s3/S3BucketInitializer.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "S3BucketInitializer", "lang": "java", "line_start": 19, "line_end": 53, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/config/s3/S3BucketInitializer.java:java:class_declaration:S3BucketInitializer:19-53", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/config/s3/S3BucketInitializer.java"}}
{"id": "src/main/java/it/aredegalli/media/config/s3/S3Config.java:treesitter:0", "text": "package it.aredegalli.media.config.s3;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport software.amazon.awssdk.auth.credentials.AwsBasicCredentials;\nimport software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;\nimport software.amazon.awssdk.core.client.config.ClientOverrideConfiguration;\nimport software.amazon.awssdk.http.SdkHttpClient;\nimport software.amazon.awssdk.http.apache.ApacheHttpClient;\nimport software.amazon.awssdk.regions.Region;\nimport software.amazon.awssdk.services.s3.S3Client;\nimport software.amazon.awssdk.services.s3.S3Configuration;\nimport java.net.URI;\nimport java.time.Duration;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/config/s3/S3Config.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/config/s3/S3Config.java"}}
{"id": "src/main/java/it/aredegalli/media/config/s3/S3Config.java:treesitter:0", "text": "package it.aredegalli.media.config.s3;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport software.amazon.awssdk.auth.credentials.AwsBasicCredentials;\nimport software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;\nimport software.amazon.awssdk.core.client.config.ClientOverrideConfiguration;\nimport software.amazon.awssdk.http.SdkHttpClient;\nimport software.amazon.awssdk.http.apache.ApacheHttpClient;\nimport software.amazon.awssdk.regions.Region;\nimport software.amazon.awssdk.services.s3.S3Client;\nimport software.amazon.awssdk.services.s3.S3Configuration;\nimport java.net.URI;\nimport java.time.Duration;\n@Configuration\n@EnableConfigurationProperties(S3Properties.class)\n@RequiredArgsConstructor\npublic class S3Config {\n\npackage it.aredegalli.media.config.s3;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport software.amazon.awssdk.auth.credentials.AwsBasicCredentials;\nimport software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;\nimport software.amazon.awssdk.core.client.config.ClientOverrideConfiguration;\nimport software.amazon.awssdk.http.SdkHttpClient;\nimport software.amazon.awssdk.http.apache.ApacheHttpClient;\nimport software.amazon.awssdk.regions.Region;\nimport software.amazon.awssdk.services.s3.S3Client;\nimport software.amazon.awssdk.services.s3.S3Configuration;\nimport java.net.URI;\nimport java.time.Duration;\n\n@Configuration\n@EnableConfigurationProperties(S3Properties.class)\n@RequiredArgsConstructor\npublic class S3Config {\n    private final S3Properties s3Properties;\n    @Bean\n    public S3Client s3Client() {\n        SdkHttpClient httpClient = ApacheHttpClient.builder()\n                .connectionTimeout(Duration.ofSeconds(30))\n                .socketTimeout(Duration.ofMinutes(10))\n                .connectionAcquisitionTimeout(Duration.ofSeconds(30))\n                .maxConnections(100)\n                .build();\n        ClientOverrideConfiguration clientConfig = ClientOverrideConfiguration.builder()\n                .apiCallTimeout(Duration.ofMinutes(15))\n                .apiCallAttemptTimeout(Duration.ofMinutes(10))\n                .build();\n        return S3Client.builder()\n                .endpointOverride(URI.create(this.s3Properties.getEndpoint()))\n                .credentialsProvider(\n                        StaticCredentialsProvider.create(\n                                AwsBasicCredentials.create(this.s3Properties.getAccessKey(), this.s3Properties.getSecretKey())\n                        )\n                )\n                .region(Region.of(this.s3Properties.getRegion()))\n                .httpClient(httpClient)\n                .overrideConfiguration(clientConfig)\n                .serviceConfiguration(\n                        S3Configuration.builder()\n                                .pathStyleAccessEnabled(true)\n                                .chunkedEncodingEnabled(true)\n                                .build()\n                )\n                .build();\n    }\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/config/s3/S3Config.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "S3Config", "lang": "java", "line_start": 19, "line_end": 58, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/config/s3/S3Config.java:java:class_declaration:S3Config:19-58", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/config/s3/S3Config.java"}}
{"id": "src/main/java/it/aredegalli/media/config/s3/S3Properties.java:treesitter:0", "text": "package it.aredegalli.media.config.s3;\nimport lombok.Data;\nimport org.springframework.boot.context.properties.ConfigurationProperties;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/config/s3/S3Properties.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/config/s3/S3Properties.java"}}
{"id": "src/main/java/it/aredegalli/media/config/s3/S3Properties.java:treesitter:0", "text": "package it.aredegalli.media.config.s3;\nimport lombok.Data;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\n@ConfigurationProperties(prefix = \"s3.config\")\n@Data\npublic class S3Properties {\n\npackage it.aredegalli.media.config.s3;\nimport lombok.Data;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\n\n@ConfigurationProperties(prefix = \"s3.config\")\n@Data\npublic class S3Properties {\n    private String endpoint;\n    private String accessKey;\n    private String secretKey;\n    private String region;\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/config/s3/S3Properties.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "S3Properties", "lang": "java", "line_start": 6, "line_end": 13, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/config/s3/S3Properties.java:java:class_declaration:S3Properties:6-13", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/config/s3/S3Properties.java"}}
{"id": "src/main/java/it/aredegalli/media/service/component/ResourceSecureDownloadService.java:treesitter:0", "text": "package it.aredegalli.media.service.component;\nimport com.auth0.jwt.JWT;\nimport com.auth0.jwt.JWTVerifier;\nimport com.auth0.jwt.algorithms.Algorithm;\nimport com.auth0.jwt.exceptions.JWTVerificationException;\nimport com.auth0.jwt.interfaces.DecodedJWT;\nimport it.aredegalli.media.dto.SecuredResourceResponseDto;\nimport it.aredegalli.media.service.redis.RedisService;\nimport jakarta.annotation.PostConstruct;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.stereotype.Component;\nimport java.time.Duration;\nimport java.util.Date;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/service/component/ResourceSecureDownloadService.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/service/component/ResourceSecureDownloadService.java"}}
{"id": "src/main/java/it/aredegalli/media/service/component/ResourceSecureDownloadService.java:treesitter:0", "text": "package it.aredegalli.media.service.component;\nimport com.auth0.jwt.JWT;\nimport com.auth0.jwt.JWTVerifier;\nimport com.auth0.jwt.algorithms.Algorithm;\nimport com.auth0.jwt.exceptions.JWTVerificationException;\nimport com.auth0.jwt.interfaces.DecodedJWT;\nimport it.aredegalli.media.dto.SecuredResourceResponseDto;\nimport it.aredegalli.media.service.redis.RedisService;\nimport jakarta.annotation.PostConstruct;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.stereotype.Component;\nimport java.time.Duration;\nimport java.util.Date;\n@Component\n@RequiredArgsConstructor\npublic class ResourceSecureDownloadService {\n\npackage it.aredegalli.media.service.component;\nimport com.auth0.jwt.JWT;\nimport com.auth0.jwt.JWTVerifier;\nimport com.auth0.jwt.algorithms.Algorithm;\nimport com.auth0.jwt.exceptions.JWTVerificationException;\nimport com.auth0.jwt.interfaces.DecodedJWT;\nimport it.aredegalli.media.dto.SecuredResourceResponseDto;\nimport it.aredegalli.media.service.redis.RedisService;\nimport jakarta.annotation.PostConstruct;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.stereotype.Component;\nimport java.time.Duration;\nimport java.util.Date;\n\n@Component\n@RequiredArgsConstructor\npublic class ResourceSecureDownloadService {\n    @Value(\"${jwt.secret}\")\n    private String jwtSecret;\n    @Value(\"${jwt.expiration:300}\")\n    private int tokenExpirationSeconds;\n    private Algorithm algorithm;\n    private final RedisService redisService;\n    @PostConstruct\n    private void initAlgorithm() {\n        this.algorithm = Algorithm.HMAC256(jwtSecret);\n    }\n    /**\n     * Genera un token di download sicuro per una risorsa specifica\n     */\n    public String generateSecureDownloadToken(String resourceId, String bucketName) {\n        Date now = new Date();\n        Date expiration = new Date(now.getTime() + (tokenExpirationSeconds * 1000L));\n        return JWT.create()\n                .withIssuer(\"media-storage-be\")\n                .withSubject(resourceId)\n                .withClaim(\"bucketName\", bucketName)\n                .withIssuedAt(now)\n                .withExpiresAt(expiration)\n                .sign(algorithm);\n    }\n    /**\n     * Valida il token e restituisce i dati della risorsa\n     */\n    public SecuredResourceResponseDto validateTokenAndExtractResourceId(String token) {\n        if (this.redisService.getValue(token) != null) {\n            throw new JWTVerificationException(\"Token has been revoked\");\n        }\n        JWTVerifier verifier = JWT.require(algorithm)\n                .withIssuer(\"media-storage-be\")\n                .build();\n        DecodedJWT jwt = verifier.verify(token);\n        this.redisService.setValue(token, true, Duration.ofSeconds(this.tokenExpirationSeconds));\n        return SecuredResourceResponseDto.builder()\n                .key(jwt.getSubject())\n                .bucket(jwt.getClaim(\"bucketName\").asString())\n                .build();\n    }\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/service/component/ResourceSecureDownloadService.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "ResourceSecureDownloadService", "lang": "java", "line_start": 18, "line_end": 74, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/component/ResourceSecureDownloadService.java:java:class_declaration:ResourceSecureDownloadService:18-74", "child_index": 0}], "path": "src/main/java/it/aredegalli/media/service/component/ResourceSecureDownloadService.java"}}
{"id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:treesitter:0", "text": "package it.aredegalli.media.service.redis;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.core.ValueOperations;\nimport org.springframework.data.redis.core.SetOperations;\nimport org.springframework.data.redis.core.ZSetOperations;\nimport org.springframework.stereotype.Service;\nimport java.time.Duration;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\nimport java.util.concurrent.TimeUnit;", "metadata": {"source_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/main/java/it/aredegalli/media/service/redis/RedisService.java"}}
{"id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:treesitter:0", "text": "package it.aredegalli.media.service.redis;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.core.ValueOperations;\nimport org.springframework.data.redis.core.SetOperations;\nimport org.springframework.data.redis.core.ZSetOperations;\nimport org.springframework.stereotype.Service;\nimport java.time.Duration;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\nimport java.util.concurrent.TimeUnit;\n@Service\n@RequiredArgsConstructor\n@Slf4j\npublic class RedisService {\n\npackage it.aredegalli.media.service.redis;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.core.ValueOperations;\nimport org.springframework.data.redis.core.SetOperations;\nimport org.springframework.data.redis.core.ZSetOperations;\nimport org.springframework.stereotype.Service;\nimport java.time.Duration;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\nimport java.util.concurrent.TimeUnit;\n\n@Service\n@RequiredArgsConstructor\n@Slf4j\npublic class RedisService {\n    private final RedisTemplate<String, Object> redisTemplate;\n    // ========== OPERAZIONI STRING (Key-Value semplice) ==========\n    /**\n     * Salva un valore semplice con TTL.\n     * Perfetto per token temporanei, OTP, sessioni.\n     */\n    public void setValue(String key, Object value, Duration ttl) {\n        ValueOperations<String, Object> ops = redisTemplate.opsForValue();\n        ops.set(key, value, ttl);\n        log.info(\"Salvato {} in Redis con TTL di {} secondi\", key, ttl.getSeconds());\n    }\n    /**\n     * Recupera un valore e restituisce null se non esiste o è scaduto.\n     */\n    public Object getValue(String key) {\n        return redisTemplate.opsForValue().get(key);\n    }\n    /**\n     * Implementa un contatore distribuito atomico.\n     *\n     * Questo è molto utile nei microservizi per:\n     * - Rate limiting (es: max 100 richieste per minuto)\n     * - Conteggio visite/eventi\n     * - Implementare lock distribuiti\n     *\n     * L'operazione è atomica, quindi safe in ambiente distribuito!\n     */\n    public Long increment(String key) {\n        return redisTemplate.opsForValue().increment(key);\n    }\n    /**\n     * Incrementa con TTL automatico.\n     * Perfetto per rate limiting con finestre temporali.\n     *\n     * Esempio: limitare le richieste di un utente a 100 al minuto.\n     */\n    public Long incrementWithExpiry(String key, Duration ttl) {\n        Long count = redisTemplate.opsForValue().increment(key);\n        // Imposta TTL solo se è la prima volta (count == 1)\n        // Questo crea una finestra temporale che si resetta automaticamente\n        if (count != null && count == 1) {\n            redisTemplate.expire(key, ttl);\n        }\n        return count;\n    }\n    /**\n// Imposta TTL solo se è la prima volta (count == 1)\n        // Questo crea una finestra temporale che si resetta automaticamente\n        if (count != null && count == 1) {\n            redisTemplate.expire(key, ttl);\n        }\n        return count;\n    }\n    /**\n     * Rate limiting pratico: verifica se un'azione è permessa.\n     *\n     * @param userId ID dell'utente\n     * @param maxRequests Numero massimo di richieste\n     * @param window Finestra temporale\n     * @return true se l'azione è permessa, false se limite superato\n     */\n    public boolean checkRateLimit(String userId, int maxRequests, Duration window) {\n        String key = \"rate_limit:\" + userId;\n        Long currentCount = incrementWithExpiry(key, window);\n        boolean allowed = currentCount != null && currentCount <= maxRequests;\n        if (!allowed) {\n            log.warn(\"Rate limit superato per utente {}: {} richieste\", userId, currentCount);\n        }\n        return allowed;\n    }\n    // ========== OPERAZIONI HASH (Mappe annidate) ==========\n    /**\n     * Salva un oggetto come hash in Redis.\n     *\n     * Gli hash sono perfetti quando hai un oggetto con molti campi\n     * e vuoi aggiornare/recuperare singoli campi senza caricare tutto.\n     *\n     * Esempio: profilo utente dove aggiorni solo alcuni campi.\n     */\n    public void saveHash(String key, Map<String, Object> data) {\n        redisTemplate.opsForHash().putAll(key, data);\n        log.info(\"Salvato hash {} con {} campi\", key, data.size());\n    }\n    /**\n     * Recupera un singolo campo da un hash.\n     * Molto più efficiente che recuperare tutto l'oggetto!\n     */\n    public Object getHashField(String key, String field) {\n        return redisTemplate.opsForHash().get(key, field);\nredisTemplate.opsForHash().putAll(key, data);\n        log.info(\"Salvato hash {} con {} campi\", key, data.size());\n    }\n    /**\n     * Recupera un singolo campo da un hash.\n     * Molto più efficiente che recuperare tutto l'oggetto!\n     */\n    public Object getHashField(String key, String field) {\n        return redisTemplate.opsForHash().get(key, field);\n    }\n    /**\n     * Recupera tutto l'hash come mappa.\n     */\n    public Map<Object, Object> getHash(String key) {\n        return redisTemplate.opsForHash().entries(key);\n    }\n    /**\n     * Incrementa un campo numerico in un hash.\n     * Utile per statistiche aggregate (es: views, likes, shares).\n     */\n    public Long incrementHashField(String key, String field, long delta) {\n        return redisTemplate.opsForHash().increment(key, field, delta);\n    }\n    // ========== OPERAZIONI SET (Collezioni uniche) ==========\n    /**\n     * Aggiunge elementi a un set.\n     *\n     * I set sono perfetti per:\n     * - Gestire utenti online\n     * - Tag/categorie\n     * - Elementi unici senza duplicati\n     */\n    public void addToSet(String key, Object... values) {\n        SetOperations<String, Object> ops = redisTemplate.opsForSet();\n        ops.add(key, values);\n        log.info(\"Aggiunti {} elementi al set {}\", values.length, key);\n    }\n    /**\n     * Verifica se un elemento è nel set.\n     * Operazione O(1) estremamente veloce!\n     */\n    public Boolean isMemberOfSet(String key, Object value) {\n        return redisTemplate.opsForSet().isMember(key, value);\n    }\n    /**\n     * Restituisce tutti i membri del set.\n     */\n    public Set<Object> getSetMembers(String key) {\n        return redisTemplate.opsForSet().members(key);\n    }\n    /**\n     * Rimuove elementi dal set.\n     */\n    public void removeFromSet(String key, Object... values) {\n        redisTemplate.opsForSet().remove(key, values);\n    }\n    /**\n     * Esempio pratico: gestione utenti online.", "metadata": {"source_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 3, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "RedisService", "lang": "java", "line_start": 29, "line_end": 331, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:java:class_declaration:RedisService:29-331", "child_index": 0}, {"kind": "symbol_child", "node_type": "class_declaration", "symbol": "RedisService", "lang": "java", "line_start": 29, "line_end": 331, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:java:class_declaration:RedisService:29-331", "child_index": 1}, {"kind": "symbol_child", "node_type": "class_declaration", "symbol": "RedisService", "lang": "java", "line_start": 29, "line_end": 331, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:java:class_declaration:RedisService:29-331", "child_index": 2}], "path": "src/main/java/it/aredegalli/media/service/redis/RedisService.java"}}
{"id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:treesitter:1", "text": "package it.aredegalli.media.service.redis;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.core.ValueOperations;\nimport org.springframework.data.redis.core.SetOperations;\nimport org.springframework.data.redis.core.ZSetOperations;\nimport org.springframework.stereotype.Service;\nimport java.time.Duration;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\nimport java.util.concurrent.TimeUnit;\n@Service\n@RequiredArgsConstructor\n@Slf4j\npublic class RedisService {\n\npackage it.aredegalli.media.service.redis;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.core.ValueOperations;\nimport org.springframework.data.redis.core.SetOperations;\nimport org.springframework.data.redis.core.ZSetOperations;\nimport org.springframework.stereotype.Service;\nimport java.time.Duration;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\nimport java.util.concurrent.TimeUnit;\n\nredisTemplate.opsForHash().putAll(key, data);\n        log.info(\"Salvato hash {} con {} campi\", key, data.size());\n    }\n    /**\n     * Recupera un singolo campo da un hash.\n     * Molto più efficiente che recuperare tutto l'oggetto!\n     */\n    public Object getHashField(String key, String field) {\n        return redisTemplate.opsForHash().get(key, field);\n    }\n    /**\n     * Recupera tutto l'hash come mappa.\n     */\n    public Map<Object, Object> getHash(String key) {\n        return redisTemplate.opsForHash().entries(key);\n    }\n    /**\n     * Incrementa un campo numerico in un hash.\n     * Utile per statistiche aggregate (es: views, likes, shares).\n     */\n    public Long incrementHashField(String key, String field, long delta) {\n        return redisTemplate.opsForHash().increment(key, field, delta);\n    }\n    // ========== OPERAZIONI SET (Collezioni uniche) ==========\n    /**\n     * Aggiunge elementi a un set.\n     *\n     * I set sono perfetti per:\n     * - Gestire utenti online\n     * - Tag/categorie\n     * - Elementi unici senza duplicati\n     */\n    public void addToSet(String key, Object... values) {\n        SetOperations<String, Object> ops = redisTemplate.opsForSet();\n        ops.add(key, values);\n        log.info(\"Aggiunti {} elementi al set {}\", values.length, key);\n    }\n    /**\n     * Verifica se un elemento è nel set.\n     * Operazione O(1) estremamente veloce!\n     */\n    public Boolean isMemberOfSet(String key, Object value) {\n        return redisTemplate.opsForSet().isMember(key, value);\n    }\n    /**\n     * Restituisce tutti i membri del set.\n     */\n    public Set<Object> getSetMembers(String key) {\n        return redisTemplate.opsForSet().members(key);\n    }\n    /**\n     * Rimuove elementi dal set.\n     */\n    public void removeFromSet(String key, Object... values) {\n        redisTemplate.opsForSet().remove(key, values);\n    }\n    /**\n     * Esempio pratico: gestione utenti online.\n* Restituisce tutti i membri del set.\n     */\n    public Set<Object> getSetMembers(String key) {\n        return redisTemplate.opsForSet().members(key);\n    }\n    /**\n     * Rimuove elementi dal set.\n     */\n    public void removeFromSet(String key, Object... values) {\n        redisTemplate.opsForSet().remove(key, values);\n    }\n    /**\n     * Esempio pratico: gestione utenti online.\n     * Aggiungi utente quando fa login, rimuovi al logout.\n     */\n    public void markUserOnline(String userId) {\n        addToSet(\"users:online\", userId);\n        // Opzionale: aggiungi TTL per auto-cleanup se l'app crasha\n        redisTemplate.expire(\"users:online\", Duration.ofHours(1));\n    }\n    public void markUserOffline(String userId) {\n        removeFromSet(\"users:online\", userId);\n    }\n    public boolean isUserOnline(String userId) {\n        return Boolean.TRUE.equals(isMemberOfSet(\"users:online\", userId));\n    }\n    // ========== OPERAZIONI SORTED SET (Set ordinati) ==========\n    /**\n     * Aggiunge un elemento con uno score a un sorted set.\n     *\n     * I sorted set sono incredibilmente versatili:\n     * - Leaderboard/classifiche (score = punteggio)\n     * - Timeline ordinate (score = timestamp)\n     * - Priority queue (score = priorità)\n     * - Range query efficienti\n     */\n    public void addToSortedSet(String key, Object value, double score) {\n        ZSetOperations<String, Object> ops = redisTemplate.opsForZSet();\n        ops.add(key, value, score);\n    }\n    /**\n     * Recupera i top N elementi (con score più alto).\n     * Perfetto per leaderboard!\n     */\n    public Set<Object> getTopN(String key, int n) {\n        ZSetOperations<String, Object> ops = redisTemplate.opsForZSet();\n        // reverseRange restituisce in ordine decrescente (dal più alto al più basso)\n        return ops.reverseRange(key, 0, n - 1);\n    }\n    /**\n     * Recupera la posizione (rank) di un elemento.\npublic Set<Object> getTopN(String key, int n) {\n        ZSetOperations<String, Object> ops = redisTemplate.opsForZSet();\n        // reverseRange restituisce in ordine decrescente (dal più alto al più basso)\n        return ops.reverseRange(key, 0, n - 1);\n    }\n    /**\n     * Recupera la posizione (rank) di un elemento.\n     * 0 = primo posto, 1 = secondo posto, ecc.\n     */\n    public Long getRank(String key, Object value) {\n        ZSetOperations<String, Object> ops = redisTemplate.opsForZSet();\n        // reverseRank per avere 0 = score più alto\n        return ops.reverseRank(key, value);\n    }\n    /**\n     * Incrementa lo score di un elemento.\n     * Utile per aggiornare punteggi in tempo reale.\n     */\n    public Double incrementScore(String key, Object value, double delta) {\n        return redisTemplate.opsForZSet().incrementScore(key, value, delta);\n    }\n    /**\n     * Esempio pratico: leaderboard di un gioco.\n     */\n    public void updatePlayerScore(String playerId, long points) {\n        String leaderboardKey = \"leaderboard:global\";\n        incrementScore(leaderboardKey, playerId, points);\n        log.info(\"Aggiornato punteggio per player {}: +{} punti\", playerId, points);\n    }\n    public List<String> getTopPlayers(int limit) {\n        String leaderboardKey = \"leaderboard:global\";\n        Set<Object> top = getTopN(leaderboardKey, limit);\n        return top.stream()\n            .map(Object::toString)\n            .toList();\n    }\n    // ========== OPERAZIONI LIST (Code FIFO/LIFO) ==========\n    /**\n     * Aggiunge elementi alla fine di una lista (come una coda).\n     * Perfetto per job queue, message queue, log buffer.\n     */\n    public void pushToList(String key, Object... values) {\n        redisTemplate.opsForList().rightPushAll(key, values);\n    }\n    /**\n     * Rimuove e restituisce il primo elemento (FIFO).\n     * Perfetto per consumare messaggi da una queue.\n     */", "metadata": {"source_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 3, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "RedisService", "lang": "java", "line_start": 29, "line_end": 331, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:java:class_declaration:RedisService:29-331", "child_index": 2}, {"kind": "symbol_child", "node_type": "class_declaration", "symbol": "RedisService", "lang": "java", "line_start": 29, "line_end": 331, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:java:class_declaration:RedisService:29-331", "child_index": 3}, {"kind": "symbol_child", "node_type": "class_declaration", "symbol": "RedisService", "lang": "java", "line_start": 29, "line_end": 331, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:java:class_declaration:RedisService:29-331", "child_index": 4}], "path": "src/main/java/it/aredegalli/media/service/redis/RedisService.java"}}
{"id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:treesitter:2", "text": "package it.aredegalli.media.service.redis;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.core.ValueOperations;\nimport org.springframework.data.redis.core.SetOperations;\nimport org.springframework.data.redis.core.ZSetOperations;\nimport org.springframework.stereotype.Service;\nimport java.time.Duration;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\nimport java.util.concurrent.TimeUnit;\n@Service\n@RequiredArgsConstructor\n@Slf4j\npublic class RedisService {\n\npackage it.aredegalli.media.service.redis;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.core.ValueOperations;\nimport org.springframework.data.redis.core.SetOperations;\nimport org.springframework.data.redis.core.ZSetOperations;\nimport org.springframework.stereotype.Service;\nimport java.time.Duration;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\nimport java.util.concurrent.TimeUnit;\n\npublic Set<Object> getTopN(String key, int n) {\n        ZSetOperations<String, Object> ops = redisTemplate.opsForZSet();\n        // reverseRange restituisce in ordine decrescente (dal più alto al più basso)\n        return ops.reverseRange(key, 0, n - 1);\n    }\n    /**\n     * Recupera la posizione (rank) di un elemento.\n     * 0 = primo posto, 1 = secondo posto, ecc.\n     */\n    public Long getRank(String key, Object value) {\n        ZSetOperations<String, Object> ops = redisTemplate.opsForZSet();\n        // reverseRank per avere 0 = score più alto\n        return ops.reverseRank(key, value);\n    }\n    /**\n     * Incrementa lo score di un elemento.\n     * Utile per aggiornare punteggi in tempo reale.\n     */\n    public Double incrementScore(String key, Object value, double delta) {\n        return redisTemplate.opsForZSet().incrementScore(key, value, delta);\n    }\n    /**\n     * Esempio pratico: leaderboard di un gioco.\n     */\n    public void updatePlayerScore(String playerId, long points) {\n        String leaderboardKey = \"leaderboard:global\";\n        incrementScore(leaderboardKey, playerId, points);\n        log.info(\"Aggiornato punteggio per player {}: +{} punti\", playerId, points);\n    }\n    public List<String> getTopPlayers(int limit) {\n        String leaderboardKey = \"leaderboard:global\";\n        Set<Object> top = getTopN(leaderboardKey, limit);\n        return top.stream()\n            .map(Object::toString)\n            .toList();\n    }\n    // ========== OPERAZIONI LIST (Code FIFO/LIFO) ==========\n    /**\n     * Aggiunge elementi alla fine di una lista (come una coda).\n     * Perfetto per job queue, message queue, log buffer.\n     */\n    public void pushToList(String key, Object... values) {\n        redisTemplate.opsForList().rightPushAll(key, values);\n    }\n    /**\n     * Rimuove e restituisce il primo elemento (FIFO).\n     * Perfetto per consumare messaggi da una queue.\n     */\n* Perfetto per job queue, message queue, log buffer.\n     */\n    public void pushToList(String key, Object... values) {\n        redisTemplate.opsForList().rightPushAll(key, values);\n    }\n    /**\n     * Rimuove e restituisce il primo elemento (FIFO).\n     * Perfetto per consumare messaggi da una queue.\n     */\n    public Object popFromList(String key) {\n        return redisTemplate.opsForList().leftPop(key);\n    }\n    /**\n     * Operazione di blocking pop: attende fino a quando un elemento è disponibile.\n     * Questo è PERFETTO per worker che processano job da una queue!\n     *\n     * @param key Chiave della lista\n     * @param timeout Timeout massimo di attesa\n     * @return L'elemento o null se timeout\n     */\n    public Object blockingPopFromList(String key, Duration timeout) {\n        return redisTemplate.opsForList().leftPop(key, timeout.getSeconds(), TimeUnit.SECONDS);\n    }\n    /**\n     * Restituisce la dimensione della lista senza rimuovere elementi.\n     */\n    public Long getListSize(String key) {\n        return redisTemplate.opsForList().size(key);\n    }\n    // ========== UTILITY GENERICHE ==========\n    /**\n     * Elimina una o più chiavi.\n     */\n    public void delete(String... keys) {\n        redisTemplate.delete(List.of(keys));\n        log.info(\"Eliminate {} chiavi da Redis\", keys.length);\n    }\n    /**\n     * Verifica se una chiave esiste.\n     */\n    public boolean exists(String key) {\n        return Boolean.TRUE.equals(redisTemplate.hasKey(key));\n    }\n    /**\n     * Imposta TTL su una chiave esistente.\n     */\n    public void setExpiration(String key, Duration ttl) {\n        redisTemplate.expire(key, ttl);\n    }\n    /**\n     * Recupera il TTL rimanente di una chiave (in secondi).\n     * Restituisce -1 se la chiave non ha TTL, -2 se non esiste.\n     */\n    public Long getTTL(String key) {\n        return redisTemplate.getExpire(key, TimeUnit.SECONDS);\n    }\nredisTemplate.expire(key, ttl);\n    }\n    /**\n     * Recupera il TTL rimanente di una chiave (in secondi).\n     * Restituisce -1 se la chiave non ha TTL, -2 se non esiste.\n     */\n    public Long getTTL(String key) {\n        return redisTemplate.getExpire(key, TimeUnit.SECONDS);\n    }\n}", "metadata": {"source_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 3, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "RedisService", "lang": "java", "line_start": 29, "line_end": 331, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:java:class_declaration:RedisService:29-331", "child_index": 4}, {"kind": "symbol_child", "node_type": "class_declaration", "symbol": "RedisService", "lang": "java", "line_start": 29, "line_end": 331, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:java:class_declaration:RedisService:29-331", "child_index": 5}, {"kind": "symbol_child", "node_type": "class_declaration", "symbol": "RedisService", "lang": "java", "line_start": 29, "line_end": 331, "level": "child", "parent_id": "src/main/java/it/aredegalli/media/service/redis/RedisService.java:java:class_declaration:RedisService:29-331", "child_index": 6}], "path": "src/main/java/it/aredegalli/media/service/redis/RedisService.java"}}
{"id": "src/test/java/it/aredegalli/media/MediaStorageApplicationTests.java:treesitter:0", "text": "package it.aredegalli.media;\nimport org.junit.jupiter.api.Test;\nimport org.springframework.boot.test.context.SpringBootTest;", "metadata": {"source_id": "src/test/java/it/aredegalli/media/MediaStorageApplicationTests.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "preamble": true, "block_count": 1, "blocks_meta": [{"kind": "preamble", "lang": "java", "level": "parent"}], "path": "src/test/java/it/aredegalli/media/MediaStorageApplicationTests.java"}}
{"id": "src/test/java/it/aredegalli/media/MediaStorageApplicationTests.java:treesitter:0", "text": "package it.aredegalli.media;\nimport org.junit.jupiter.api.Test;\nimport org.springframework.boot.test.context.SpringBootTest;\n@SpringBootTest\nclass MediaStorageApplicationTests {\n\npackage it.aredegalli.media;\nimport org.junit.jupiter.api.Test;\nimport org.springframework.boot.test.context.SpringBootTest;\n\n@SpringBootTest\nclass MediaStorageApplicationTests {\n\t@Test\n\tvoid contextLoads() {\n\t}\n}", "metadata": {"source_id": "src/test/java/it/aredegalli/media/MediaStorageApplicationTests.java", "ext": ".java", "lang": "java", "chunker": "java_ast", "block_count": 1, "blocks_meta": [{"kind": "symbol_child", "node_type": "class_declaration", "symbol": "MediaStorageApplicationTests", "lang": "java", "line_start": 6, "line_end": 13, "level": "child", "parent_id": "src/test/java/it/aredegalli/media/MediaStorageApplicationTests.java:java:class_declaration:MediaStorageApplicationTests:6-13", "child_index": 0}], "path": "src/test/java/it/aredegalli/media/MediaStorageApplicationTests.java"}}
